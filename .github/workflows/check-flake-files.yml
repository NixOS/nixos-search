name: "Check Flake Groups"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'flakes/**.toml'

jobs:
  automatic-custom-flakes-check:

    runs-on: ubuntu-latest

    strategy:
      fail-fast: true

    env:
      RUST_LOG: debug
    
    steps:

    - name: Checking out the repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Setup
      uses: ./.github/actions/common-setup
      with:
        CACHIX_SIGNING_KEY: ${{ secrets.CACHIX_SIGNING_KEY }}

   
    - name: Building import_scripts
      run: |
        nix build ./#packages.x86_64-linux.flake-info

    - name: Try importing all custom flakes
      run: |

        for flake_group in $(find ./flakes -name "*.toml")
        do
          ./result/bin/flake-info group $flake_group $(basename $flake_group)
        done
